import cdsapi
import multiprocessing as mp
import time as t

def download_anfrage(api_url: str, api_key: str, jahr: str, monat: str, target_path: str) -> None:
    try:
        dataset: str = "reanalysis-era5-single-levels"
        anfrage: dict = {
            "product_type": ["reanalysis"],
            "variable": [
                "10m_u_component_of_wind",  #\ Windgeschwindigkeit und Richtung m/s
                "10m_v_component_of_wind",  #/
                "2m_temperature",           # Temperatur Kelvin
                "surface_pressure",         # Luftdruck Pascals
                "2m_dewpoint_temperature",  # Luftfeuchtigkeit
                "total_precipitation",      # Niederschlag Meter
                "snow_depth"                # Schneetiefe Meter
                ],
            "year": [jahr],
            "month": [monat],
            "day": [
                "01", "02", "03", "04", "05", "06",
                "07", "08", "09", "10", "11", "12",
                "13", "14", "15", "16", "17", "18",
                "19", "20", "21", "22", "23", "24",
                "25", "26", "27", "28", "29", "30", "31"
                ],
            "time": [
                "00:00", "01:00", "02:00", "03:00", "04:00", "05:00",
                "06:00", "07:00", "08:00", "09:00", "10:00", "11:00",
                "12:00", "13:00", "14:00", "15:00", "16:00", "17:00",
                "18:00", "19:00", "20:00", "21:00", "22:00", "23:00"
                ],
            "data_format": "netcdf",
            "download_format": "zip",
            "area": [72, -25, 34, 45]
            }
        name: str = f"era5_{jahr}_{monat}.zip"
        print(f"\n\033[91mDownload von {name} angefangen\033[0m")
        client: object = cdsapi.Client(url = api_url, key = api_key, quiet = True)
        client.retrieve(dataset, anfrage).download(target_path + name)
        print(f"\n\033[92m{name} erfolgreich heruntergeladen\033[0m")
    except Exception as e:
        print(e)
        t.sleep(1800)
        download_anfrage(api_url = api_url, api_key = api_key, jahr = jahr, monat = monat, target_path = target_path)

if __name__ == "__main__":
    fertig: dict = {
        "1940": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1941": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1942": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1943": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1944": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1945": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1946": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1947": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1948": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1949": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1950": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1951": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1952": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1953": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1954": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1955": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1956": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1957": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1958": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1959": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1960": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1961": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1962": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1963": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1964": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1965": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1966": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1967": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1968": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1969": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1970": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1971": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1972": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1973": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1974": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1975": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1976": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1977": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1978": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1979": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1980": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1981": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1982": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1983": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1984": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1985": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1986": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1987": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1988": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1989": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1990": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1991": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1992": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1993": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1994": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1995": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1996": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1997": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1998": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "1999": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "2000": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "2001": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "2002": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "2003": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "2004": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "2005": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "2006": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "2007": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "2008": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "2009": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "2010": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "2011": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "2012": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "2013": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "2014": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "2015": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "2016": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "2017": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "2018": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "2019": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "2020": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "2021": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "2022": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        "2023": ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        }
    jahre: list = [str(year) for year in range(1940, 2024)]
    monate: list = ["01","02","03","04","05","06","07","08","09","10","11","12"]
    url: str = "https://cds.climate.copernicus.eu/api"
    api_keys: list = ["YOUR_API_KEYS_HERE", 
                      "YOUR_API_KEYS_HERE", 
                      "YOUR_API_KEYS_HERE",
                      "YOUR_API_KEYS_HERE",
                      "YOUR_API_KEYS_HERE", 
                      "YOUR_API_KEYS_HERE", 
                      "YOUR_API_KEYS_HERE", 
                      "YOUR_API_KEYS_HERE",
                      "YOUR_API_KEYS_HERE",
                      "YOUR_API_KEYS_HERE",
                      "YOUR_API_KEYS_HERE",
                      "YOUR_API_KEYS_HERE"]
    amount_api_keys: int = len(api_keys)
    list_of_queues: list = []

    for _ in range(0, amount_api_keys):
        list_of_queues.append([])
    
    index: int = 0
    for jahr in jahre:
        for monat in monate:
            if monat not in fertig[jahr]:
                process = mp.Process(target=download_anfrage, args=(url, api_keys[index], jahr, monat, "downloaded_era5_datasets/"))
                list_of_queues[index].append(process)
                index += 1
                if index == amount_api_keys:
                    index = 0

    def all_queues_empty() -> bool:
        empty: bool = True
        for queue in list_of_queues:
            if len(queue) != 0:
                empty = False
        return empty
    
    for queue in list_of_queues:
        queue[0].start()
    while all_queues_empty() != True:
        for queue in list_of_queues:
            try:
                if queue[0].is_alive() == False:
                    if len(queue) == 0:
                        list_of_queues.pop(list_of_queues.index(queue))
                    queue.pop(0)
                    queue[0].start()
            except:
                pass
        t.sleep(10)